name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to EC2
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        EC2_HOST: ${{ secrets.EC2_HOST }}
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        SES_FROM_EMAIL: ${{ secrets.SES_FROM_EMAIL }}
        S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
        
        # Deploy to server
        ssh -i ~/.ssh/deploy_key ubuntu@$EC2_HOST << 'ENDSSH'
          cd ~/Study-Organizer
          git pull origin main
          echo "Code pulled successfully!"
        ENDSSH
        
        # Update .env files with secrets (done separately to pass env vars)
        ssh -i ~/.ssh/deploy_key ubuntu@$EC2_HOST bash << EOF
          cd ~/Study-Organizer
          
          # Backend .env
          echo "MONGODB_URI=$MONGODB_URI" > .env
          echo "JWT_SECRET=$JWT_SECRET" >> .env
          echo "PORT=5000" >> .env
          echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> .env
          echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> .env
          echo "SES_FROM_EMAIL=$SES_FROM_EMAIL" >> .env
          echo "AWS_REGION=eu-central-1" >> .env
          echo "FRONTEND_URL=http://$EC2_HOST:5173" >> .env
          echo "S3_BUCKET_NAME=$S3_BUCKET_NAME" >> .env
          
          # Frontend .env with EC2_HOST from GitHub Secrets
          echo "VITE_API_URL=http://$EC2_HOST:5000/api" > frontend/.env
          
          echo "Environment files updated!"
          cat frontend/.env
          
          # Rebuild and restart containers
          sudo docker compose down
          sudo docker compose up -d --build
          
          echo "Deployment completed successfully!"
        EOF