name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to EC2
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        EC2_HOST: ${{ secrets.EC2_HOST }}
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
        
        # Deploy to server with secrets passed as arguments
        ssh -i ~/.ssh/deploy_key ubuntu@$EC2_HOST "bash -s" << EOF
          cd ~/Study-Organizer
          
          # Pull latest code
          git pull origin main
          
          # Update .env files with secrets
          echo "MONGODB_URI=$MONGODB_URI" > .env
          echo "JWT_SECRET=$JWT_SECRET" >> .env
          echo "PORT=5000" >> .env
          
          # Get public IP and update frontend env
          PUBLIC_IP=\$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
          echo "VITE_API_URL=http://\$PUBLIC_IP:5000/api" > frontend/.env
          
          # Update docker-compose with correct frontend env
          cat > docker-compose.yml << 'COMPOSE_EOF'
version: '3.8'
services:
  backend:
    build: ./backend
    ports:
      - "5000:5000"
    environment:
      - MONGODB_URI=\${MONGODB_URI}
      - JWT_SECRET=\${JWT_SECRET}
      - PORT=5000
    volumes:
      - ./backend/uploads:/app/uploads
  frontend:
    build: ./frontend
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://\$PUBLIC_IP:5000/api
    depends_on:
      - backend
COMPOSE_EOF
          
          # Restart containers
          sudo docker compose down
          sudo docker compose up -d --build
          
          echo "Deployment completed successfully!"
EOF