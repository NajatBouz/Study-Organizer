name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to EC2
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        EC2_HOST: ${{ secrets.EC2_HOST }}
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
        
        # Deploy to server
        ssh -i ~/.ssh/deploy_key ubuntu@$EC2_HOST << 'ENDSSH'
          cd ~/Study-Organizer
          
          # Pull latest code
          git pull origin main
          
          # Update .env files
          echo "MONGODB_URI=$MONGODB_URI" > .env
          echo "JWT_SECRET=$JWT_SECRET" >> .env
          echo "PORT=5000" >> .env
          
          # Get public IP and update frontend env
          PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
          echo "VITE_API_URL=http://$PUBLIC_IP:5000/api" > frontend/.env
          
          # Restart containers
          sudo docker compose down
          sudo docker compose up -d --build
          
          echo "Deployment completed successfully!"
        ENDSSH